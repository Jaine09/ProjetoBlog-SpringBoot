<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Blog</title>
    <link rel="stylesheet" type="text/css" href="stylesheet.css">
</head>
<body>
<div class="container">
    <h1>Blog</h1>

    <div id="tela-lista">
        <div id="artigos"></div>
        <div class="center">
            <button id="btn-novo">Incluir novo texto</button>
        </div>
    </div>

    <div id="tela-formulario" style="display:none;">
        <div class="card form-card">
            <h2>Novo texto</h2>
            <div class="form-row">
                <label>Título</label>
                <input id="titulo" />
            </div>
            <div class="form-row">
                <label>Autor</label>
                <input id="autor" />
            </div>
            <div class="form-row">
                <label>Data de publicação</label>
                <input id="dataPubli" type="date"/>
            </div>
            <div class="form-row">
                <label>Texto</label>
                <textarea id="texto" rows="6"></textarea>
            </div>
            <div class="center">
                <button id="btn-salvar">Salvar</button>
                <button id="btn-cancelar" class="secondary">Cancelar</button>
            </div>
            <div id="mensagem" class="message"></div>
        </div>
    </div>

</div>

<script>
    const API = 'http://localhost:8080/blog';

document.addEventListener('DOMContentLoaded', () => {
  carregarArtigos();

  document.getElementById('btn-novo').addEventListener('click', () => mostrarFormulario());
  document.getElementById('btn-cancelar').addEventListener('click', () => mostrarLista());
  document.getElementById('btn-salvar').addEventListener('click', salvarArtigo);
});

function mostrarFormulario(){
  document.getElementById('tela-lista').style.display = 'none';
  document.getElementById('tela-formulario').style.display = 'block';
  limparFormulario();
}

function mostrarLista(){
  document.getElementById('tela-lista').style.display = 'block';
  document.getElementById('tela-formulario').style.display = 'none';
}

function limparFormulario(){
  document.getElementById('titulo').value = '';
  document.getElementById('autor').value = '';
  document.getElementById('dataPubli').value = new Date().toISOString().slice(0,10);
  document.getElementById('texto').value = '';
  document.getElementById('mensagem').innerText = '';
}

async function carregarArtigos(){
  try {
    const resp = await fetch(API);
    const data = await resp.json();
    renderizarArtigos(data);
  } catch(err){
    console.error(err);
    document.getElementById('artigos').innerHTML = '<p>Erro ao carregar artigos.</p>';
  }
}

function renderizarArtigos(lista){
  const container = document.getElementById('artigos');
  container.innerHTML = '';
  if(!lista || lista.length === 0){
    container.innerHTML = '<p>Nenhum texto cadastrado.</p>';
    return;
  }
  for(const a of lista){
    const card = document.createElement('div');
    card.className = 'article-card';
    const titulo = document.createElement('div');
    titulo.className = 'article-title';
    titulo.innerText = a.titulo;
    card.appendChild(titulo);

    const meta = document.createElement('div');
    const pub = a.dataPubli;
    const dataFormatada = new Date(pub).toLocaleDateString();
    meta.innerHTML = `<strong>Autor:</strong> ${a.autor} <br> <strong>Publicado em:</strong> ${dataFormatada}`;

    const hoje = new Date();
    const dpub = new Date(pub);
    if(dpub > new Date(hoje.toDateString())){
      meta.innerHTML += ` <span class="badge">NÃO PUBLICADO</span>`;
    }
    card.appendChild(meta);

    const resumo = document.createElement('p');
    resumo.innerText = a.texto;
    card.appendChild(resumo);

    container.appendChild(card);
  }
}

async function salvarArtigo(){
  const dto = {
    titulo: document.getElementById('titulo').value.trim(),
    autor: document.getElementById('autor').value.trim(),
    dataPubli: document.getElementById('dataPubli').value,
    texto: document.getElementById('texto').value.trim()
  };

  const msg = document.getElementById('mensagem');
  msg.style.color = 'red';
  if(!dto.titulo || !dto.autor || !dto.dataPubli || !dto.texto){
    msg.innerText = 'Todos os campos são obrigatórios.';
    return;
  }
  if(dto.texto.length < 10){
    msg.innerText = 'O texto deve ter no mínimo 10 caracteres.';
    return;
  }
  const hoje = new Date().toISOString().slice(0,10);
  if(dto.dataPubli < hoje){
    msg.innerText = 'A data de publicação deve ser hoje ou no futuro.';
    return;
  }

  try {
    const resp = await fetch(API, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(dto)
    });

    if(resp.ok){
      msg.style.color = 'green';
      msg.innerText = 'Texto salvo com sucesso!';

      await carregarArtigos();

      setTimeout(() => mostrarLista(), 700);
    } else {
      const err = await resp.json();

      if(err.errors) {
        msg.innerText = err.errors.join(' | ');
      } else if(err.error){
        msg.innerText = err.error;
      } else {
        msg.innerText = 'Erro ao salvar (servidor).';
      }
    }
  } catch(e){
    msg.innerText = 'Erro ao conectar com o servidor.';
    console.error(e);
  }
}

</script>
</body>
</html>
